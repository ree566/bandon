$(document).ready(function () {
    var paid_temp = {};

    $("form").parent().removeClass();

    if (Cookies.get("paid_temp") != null) {
        paid_temp = Cookies.getJSON("paid_temp");
    }

    $(".order-paid").on("keyup change", function () {

        var row = $(this).parents(".order");

        var paid = parseInt($(this).val());
        var balanceField = row.find(".balance-calc");
        var balance = parseInt(row.find(".origin-balance").val());
        var purse_id = row.find(".purse_id").html();

        if (isNaN(paid)) {
            balanceField.html(balance);
            delete paid_temp["P" + purse_id];
            return false;
        }

        var totalPrice = parseInt(row.find(".totalPrice").html());
        balanceField.html(balance - totalPrice + paid);

        paid_temp["P" + purse_id] = paid;

    });

    $(".reset").on("click", function () {
        if (confirm("Confirm reset?")) {
            $("form").find(".order-paid, .order-remark").val(null);
            paid_temp = {};
            Cookies.remove('paid_temp');
            $(".order").each(function () {
                var row = $(this);
                var balance_calc = row.find(".balance-calc").html(row.find(".origin-balance").val());
            });
        }
    });

    $(".submit").on("click", function () {
        if (confirm("資料確認無誤? 送出後無法再做修改")) {

            var c = [];

            function a() {
                // console.log(Cookies.get('paid_temp'));
                Cookies.remove('paid_temp');
                // Cookies.remove('paid_temp', { path: '' });
                alert("儲存成功！");
                location.replace("order-checkout.php");
            }

            function b() {
                alert("發生錯誤！");
            }

            $(".order").each(function () {
                var paid = $(".order-paid", this).val();
                var remark = $(".order-remark", this).val();
                var user_id = $(".user_id", this).html();
                var purse_id = $(".purse_id", this).html();
                var order_id = $(".order_id", this).html();
                var totalPrice = $(".totalPrice", this).html();

                if (isNaN(paid) || paid == null || paid == "") {
                    paid = totalPrice;
                }

                var obj = {
                    paid: paid,
                    remark: remark,
                    user_id: user_id,
                    purse_id: purse_id,
                    order_id: order_id,
                    totalPrice: totalPrice
                };

                if (remark != null && remark.trim() == "") {
                    delete obj.remark;
                }

                c.push(obj);

            });

            if (c.length == 0) {
                alert("無資料");
                return false;
            }

            var data = {
                orders: c
            };

            return myPost("set-checkout-orders", data, a, b, this);
        }
        return false;
    })
    ;

    window.onbeforeunload = function (event) {

        if (!$.isEmptyObject(paid_temp)) {
            Cookies.set("paid_temp", JSON.stringify(paid_temp), {expires: 1});
        } else {
            Cookies.remove('paid_temp');
        }

    };

})
;

