/*! bandon 2014-08-08 */

!function(){function a(){function a(a){s=a.groups,l(),n()}function b(a){console.log(a),alert("載入店家列表失敗！")}myPost("get-groups","",a,b)}function b(a){var b=$('<div class="kind input-group" data-kid="'+a.id+'"><input class="form-control kind-name" type="text" placeholder="種類" value="'+a.name+'"><input class="form-control kind-price" type="text" placeholder="價格" value="'+a.price+'"><label class="wrap-checkbox input-group-addon"><input type="checkbox" class="kind-delete"> 刪除</label></div>');return b}function c(a){var c=$('<div class="form-group item" data-iid="'+a.id+'"><div class="col-md-5"><div class="input-group"><label class="wrap-checkbox input-group-addon"><input type="checkbox" class="item-delete"> 刪除</label><input type="text" placeholder="項目" class="item-name form-control" value="'+a.name+'"></div></div><div class="col-md-5 kind-list"></div><div class="col-md-2"><button　type="button" class="add-kind btn btn-default">增加種類</button></div></div>');return a.kinds.forEach(function(a){$(".kind-list",c).append(b(a))}),$(".add-kind",c).click(function(){var d={id:0,item_id:a.id,name:"",price:0};a.kinds.push(d),$(".kind-list",c).append(b(d))}),c}function d(){function b(){var a={id:0,name:"",group_id:r.id,kinds:[{id:0,item_id:0,name:"",price:0}]};r.items.push(a),$(".item-list").append(c(a))}function e(){function b(b){alert("儲存成功！"),r=b.group,d(),a()}function c(a){console.log(a),alert("儲存失敗！"+(a.error||""))}var e={group:{id:r.id,name:$(".group-name").val(),tel:$(".group-tel").val(),items:[],"delete":$(".group-delete").is(":checked")}};return $(".item").each(function(){var a={id:$(this).data("iid"),name:$(".item-name",this).val(),"delete":$(".item-delete",this).is(":checked"),group_id:r.id,kinds:[]};$(".kind",this).each(function(){var b={id:$(this).data("kid"),name:$(".kind-name",this).val(),price:$(".kind-price",this).val(),"delete":$(".kind-delete",this).is(":checked"),item_id:a.id};a.kinds.push(b)}),e.group.items.push(a)}),myPost("set-group",e,b,c,this),!1}return r?($(".group").html(T('			{using}			<div class="input-group">				<input class="group-name form-control input-lg" type="text" value="{group_name}">				<label class="input-group-addon">					<input type="checkbox" class="group-delete">					刪除				</label>			</div>			<div class="row">				<div class="col-md-5 col-md-offset-7">					<div class="input-group">						<div class="input-group-addon">電話︰</div>						<input type="text" class="group-tel form-control input-sm" value="{group_tel}" placeholder="電話號碼" />					</div>				</div>			</div>			<p><form action="" class="form-horizontal item-list"></form></p><p class="text-danger">一個項目必需至少包含一個種類！</p><div class="btn-group"><button type="button" class="add-item btn btn-default">新增項目</button><button type="button" class="submit btn btn-default">儲存</button><button type="button" class="manage-detail btn btn-default">修改細項</button></div>',{group_name:r.name,group_tel:r.tel,using:r.floors.length?'<p class="text-danger">'+r.floors.map(function(a){return a.name}).join("、")+"使用中</p>":""})),r.items.forEach(function(a){$(".item-list").append(c(a))}),$(".group .add-item").click(b),$(".group .submit").click(e),void $(".group .manage-detail").click(g)):void $(".group").html("")}function e(a){var b=[];a.options&&a.options.forEach(function(a){b.push(a.name)});var c=$('<div class="form-group detail" data-did="'+a.id+'"><div class="col-sm-10"><div class="input-group"><input type="text" placeholder="項目名稱" value="'+a.name+'" class="detail-name form-control"><input type="text" placeholder="項目1, 項目2, 項目3, ..." value="'+b.join(", ")+'" class="detail-options form-control"><input type="text" placeholder="價格" value="'+a.price+'" class="detail-price form-control"></div></div><div class="col-sm-2 checkbox"><label><input type="checkbox" class="detail-delete">刪除</label></div></div>');return $(".detail-name",c).change(function(){var b=$(this).val();r.details.forEach(function(c){a.id==c.id&&(c.name=b)}),f()}),c}function f(a){a=a||r;var b=$('<table class="table"><thead class="text-center"><tr class="heading"><th></th></tr></thead><tbody></tbody></table>');a.details.forEach(function(a){$(".heading",b).append("<th>"+a.name+"</th>")}),a.items.forEach(function(c){var d=[];a.details.forEach(function(a){var b=c.id+"-"+a.id;d.push(T('<td><input class="item-detail-check item-detail-{id}" type="checkbox" data-item-detail="{id}"></td>',{id:b}))}),$("tbody",b).append("<tr><th>"+c.name+"</th>"+d.join()+"</tr>")}),$(".item-detail-list").html(""),$(".item-detail-list").append(b),console.log(r.item_detail),r.item_detail.forEach(function(a){var b=a.item_id+"-"+a.detail_id;console.log(b,$(".item-detail-"+b)),$(".item-detail-"+b).prop("checked",!0)})}function g(){function a(){function a(a){r.details.push(a.detail),$(".group .detail-list").append(e(a.detail)),f()}function b(a){console.log(a),alert("設定細項失敗！")}var c={detail:{id:0,group_id:r.id,name:"",price:0,options:[]}};myPost("set-detail",c,a,b)}function b(){function a(a){alert("儲存成功！"),r=a.group,g()}function b(a){console.log(a),alert("儲存失敗！"+(a.error||""))}var c=[];$(".detail").each(function(){for(var a={id:$(this).data("did"),name:$(".detail-name",this).val(),price:$(".detail-price",this).val(),group_id:r.id,"delete":$(".detail-delete",this).is(":checked"),options:[]},b=$(".detail-options",this).val().split(/\s*,\s*/),d=0;d<b.length;d++)b[d]&&a.options.push({id:0,name:b[d],detail_id:a.id});c.push(a)}),c.forEach(function(a){var b=null;r.details.forEach(function(c){return c.id==a.id?(b=c,!1):!0}),console.log(b),b&&b.options.forEach(function(b,c){a.options[c]?a.options[c].id=b.id:a.options[c]={id:b.id,"delete":!0}})});var d=[];$(".item-detail-check:checked").each(function(){var a=$(this).data("itemDetail");d.push({item_id:a.split("-")[0],detail_id:a.split("-")[1]})}),console.log(d);var e={group:{id:r.id,name:r.name,details:c,item_detail:d}};return myPost("set-group",e,a,b,this),!1}$(".group").html('<p class="detail-list"></p><p><button type="button" class="add-detail btn btn-default">新增細項</button></p><div class="table-responsive item-detail-list"></div><div class="btn-group"><button type="button" class="submit btn btn-default">儲存</button><button type="button" class="manage-item btn btn-default">修改項目</button></div>'),r.details.forEach(function(a){$(".group .detail-list").append(e(a))}),f(),$(".manage-item").click(d),$(".add-detail").click(a),$(".submit").click(b)}function h(a){function b(a){r=a.group,d()}function c(a){console.log(a),alert("取得店家資訊失敗！")}if(!a){if(location.href.indexOf("#")<0)return;a=location.href.split("#")[1]}var e={group_id:a};myPost("get-group",e,b,c)}function i(a){a=a||location.hash.replace("#",""),$(".group-list li").removeClass("active"),a&&$(T("[href='#{}']",[a])).parent().addClass("active")}function j(){var a=$("a",this).attr("href").substr(1);i(a),h(a)}function k(){function a(a){s=a.groups,m()}function b(a){console.log(a),alert("載入店家列表失敗！")}myPost("get-groups","",a,b)}function l(){var a=[];s.forEach(function(b){var c=T('<li><a href="#{group_id}">{group_name}</a></li>',{group_id:b.id,group_name:b.name});a.push(c)}),$(".group-list").html(a.join(""))}function m(){l(),i(),q(),h()}function n(){$(".nav-pills li").click(j)}function o(){$(".add-group").click(p)}function p(){function b(b){r=b.group,$(".add-group-name").val(""),location.href="#"+r.id,d(),a()}function c(a){console.log(a),alert("發生錯誤！")}var e=$(".add-group-name").val();if(!e)return alert("請勿留空！"),!1;var f={group:{id:0,name:e}};return myPost("set-group",f,b,c),!1}function q(){n(),o()}var r=null,s=null;document.addEventListener("DOMContentLoaded",k,!1)}();
//# sourceMappingURL=manage-group.js.map