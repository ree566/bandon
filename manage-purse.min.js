$(function () {
    var purseMin = purse_min_allow, purseMax = purse_max_allow;

    $(".submit").click(function () {

        if (!confirm("確認儲存?")) {
            return false;
        }

        var c = [];

        function a() {
            alert("儲存成功！"), location.replace("manage-purse.php");
        }

        function b(e) {
            alert("發生錯誤！" + e.error);
        }

        $(".purse").each(function () {
            var adjust = $(".adjust_num", this).val();
            var remark = $(".order-remark", this).val();
            var user_id = $(".user_id", this).html();
            var purse_id = $(".purse_id", this).html();
            var amount = $(".amount", this).html();

            if (!isNaN(adjust) && adjust != 0) {
                var balance = parseInt(amount) + parseInt(adjust);

                if(balance > purseMax || balance < purseMin){
                    alert(user_id + " 餘額不可小於" + purseMin + "或大於" + purseMax + "(" + balance + ")");
                    return false;
                }

                if (remark == null || remark == "") {
                    alert(user_id + " 備註不可為空");
                    return false;
                }

                c.push({
                    purse_id: purse_id,
                    adjust: adjust,
                    amount: amount,
                    remark: remark,
                    user_id: user_id
                })
            }
        });

        if (c.length != 0) {
            var data = {
                purses: c
            };
            return myPost("set-purses", data, a, b, this);
        } else {
            alert("無資料異動");
        }
    });
});

